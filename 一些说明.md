[解析SPU与SKU一、SPU与SKU详解 1. 基本定义 SPU（Standard Product Unit - 掘金](https://juejin.cn/post/7523031603133906996)[解析SPU与SKU一、SPU与SKU详解 1. 基本定义 SPU（Standard Product Unit - 掘金](https://juejin.cn/post/7523031603133906996)

```sql
CREATE TABLE items (
    item_id BIGSERIAL PRIMARY KEY,
    seller_id BIGINT,
    title VARCHAR(512),
    description TEXT,
    brand VARCHAR(128),
    primary_category_id BIGINT,
    status VARCHAR(32), -- active/off_shelf
    created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE item_sku (
    sku_id BIGSERIAL PRIMARY KEY,
    item_id BIGINT REFERENCES items(item_id),
    sku_title VARCHAR(512),
    price DECIMAL(10,2),
    stock INT,
    sku_code VARCHAR(128),     -- SKU 编码
    image_url TEXT,            -- 可选：SKU 图
    weight DECIMAL(10,2),      -- 可选：物流计算
    status VARCHAR(32),
    created_at TIMESTAMP DEFAULT now()
);

CREATE TABLE item_spec (
    spec_id BIGSERIAL PRIMARY KEY,
    name VARCHAR(128)          -- 例如 “颜色”, “容量”, “套餐”
);

CREATE TABLE item_spec_value (
    value_id BIGSERIAL PRIMARY KEY,
    spec_id BIGINT REFERENCES item_spec(spec_id),
    value VARCHAR(128)
);

CREATE TABLE item_sku_spec (
    sku_id BIGINT REFERENCES item_sku(sku_id),
    value_id BIGINT REFERENCES item_spec_value(value_id),
    PRIMARY KEY (sku_id, value_id)
);

```

![1764317093230](image\1764317093230.png)

```
erDiagram
    SPU {
        int spu_id PK "SPU ID"
        string name "商品名 (如: iPhone 15 Pro)"
        int category_id FK "分类ID"
        string description "描述"
        jpg image "图片描述"
    }

    SKU {
        int sku_id PK "SKU ID"
        int origin_price "原价"
        int now_price "现价"
        string barcode "条形码"
    }

    warehouse{
        int code PK "仓库编号"
        addr address  "地址"
    }

    AttributeKey {
        int attr_id PK "属性键ID"
        string attr_name "属性名称 (如: 颜色)"
    }

    AttributeValue {
        int value_id PK "属性值ID"
        int attr_id FK "所属属性键ID"
        string value_name "属性值 (如: 蓝色、256GB)"
    }

    %% 超类型：Account (账号)
    Account {
        int account_id PK "账号ID"
        string username "用户名"
        string password_hash "密码哈希"
        string email "邮箱"
        bool have_shop "是否有店铺"
        datetime created_at "创建时间"
    }

    %% 子类型：Customer (客户)
    Customer {
        int account_id PK, FK "继承自账号ID"
    }

    %% 子类型：Merchant (商家)
    Merchant {
        int account_id PK, FK "继承自账号ID"
    }

    Shop {
        int shop_ID PK "店铺ID"
        string shop_name "店名"
    }

    shipping_address {
        addr address "收货地址"
        string phone_number "联系电话"
        string name "联系人姓名"
    }

    Cart {
        int cart_id PK "购物车编号，加入购物车不影响库存"
    }

    Order {
        int order_id PK "订单编号"
        enum status "订单状态"
    }
    Order_item {
        int order_item_id PK "订单详细列表编号"
        int number "check store_number"
        addr warehouse_addr_snapshot "check warehouse.address"
        addr shipping_address_snapshot "check shipping_address.addr"
    }

    %% 联系定义
  
    %% SPU 和 SKU 之间是 1:N 关系
    SPU ||--o{ AttributeKey : options

    %% AttributeKey 和 AttributeValue 之间是 1:N 关系
    AttributeKey ||--o{ AttributeValue : 属性值

    %% SKU 通过 SKUAttributeValue 关联到具体的属性值 (N:M 关系)
    SKU }|--|{ AttributeValue : 拥有

    warehouse ||--o{ SKU : store_number

    %% 关系：1:1 识别关系 (继承)
    %% 每个 Account 记录要么是 Customer，要么是 Merchant
  
    Account ||--o{ Customer : 关联客户信息
    Account ||--o{ Merchant : 关联商家信息
    Shop ||--o{ warehouse : 店铺信息
    Merchant ||--o{ Shop : 店铺信息_1to3
    Customer ||--o{ shipping_address : 收件信息_isdefault
    Cart ||--|| Customer : 购物车
    Cart ||--o{ SKU: 购物车存储_number
    Order ||--o{ Order_item: 订单详细信息
    Customer ||--o{ Order: 用户订单

```

协同过滤推荐（物品-物品的）、基于内容的推荐、基于知识的推荐

###### opengauss

```bash
docker build -f dockerfile_arm -t opengauss:6.0.2 .

docker run -d --name opengauss-1 --privileged -e "GS_PASSWORD=Aa1@#456&*" -e "GS_USERNAME=aderversa" -p 5432:5432 opengauss:6.0.2
使用openGauss镜像的时候，必须设置该参数。该参数值不能为空或者不定义。该参数设置了openGauss数据库的超级用户omm以及测试用户gaussdb的密码。openGauss安装时默认会创建omm超级用户，该用户名暂时无法修改。测试用户gaussdb是在entrypoint.sh中自定义创建的用户。

docker exec -it opengauss-1 sh
su omm
gsql
\l#查看所有数据库
create database mydb;

\du返回用户
-- 1. 创建用户（使用 CREATE USER 或 CREATE ROLE）
CREATE USER username WITH PASSWORD 'password';
testuser:abc45(78

-- 2. 连接到目标数据库 mydb
\c mydb

-- 3. 授予用户对数据库的基本权限
-- 连接权限
ALTER ROLE aderversa LOGIN;
GRANT CONNECT ON DATABASE mydb TO username;

-- 4. 授予 SCHEMA 权限（通常是 public schema）
GRANT USAGE ON SCHEMA public TO username;

-- 5. 授予表的操作权限
GRANT CREATE ON SCHEMA public TO username;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO username;

-- 6. 授予序列权限（用于自增ID）
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO username;

-- 7. 授予视图权限
GRANT SELECT ON ALL VIEWS IN SCHEMA public TO username; --报错？
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO aderversa;

-- 8. 设置默认权限（对后续创建的对象自动应用）
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO username;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT USAGE, SELECT ON SEQUENCES TO username;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON VIEWS TO username;
GRANT CONNECT ON DATABASE mydb TO aderversa;
GRANT USAGE ON SCHEMA public TO aderversa; #获得浏览表的权利
GRANT CREATE ON SCHEMA public TO aderversa; #获得创建表的权利
之后可以登陆到aderversa
gsql -d mydb -U aderversa -W "Aa1@#456&*"

\dn+ public
```

###### 创建表

```sql
CREATE TABLE SPU (
    spu_id INT PRIMARY KEY,
    name VARCHAR(255),
    category_id INT,
    description TEXT,
    image_url VARCHAR(255)
);
CREATE TABLE SKU (
    sku_id INT PRIMARY KEY,
    origin_price INT,
    now_price DECIMAL(10,2),
    barcode VARCHAR(100)
);
CREATE TABLE warehouse (--一般先有shop再有warehouse
    code INT PRIMARY KEY,
    address VARCHAR(255)
    shop_id int FOREIGN KEY (shop_id) REFERENCES Shop(shop_id)
);
CREATE TABLE AttributeKey (
    attr_id INT PRIMARY KEY,
    attr_name VARCHAR(100)
    spu_id int FOREIGN KEY(spu_id) REFERENCES SPU(spu_id)
);
CREATE TABLE AttributeValue ( 
    value_id INT PRIMARY KEY,
    attr_id INT,
    value_name VARCHAR(100),
    FOREIGN KEY (attr_id) REFERENCES AttributeKey(attr_id)
);
CREATE TABLE Shop (
    shop_id INT PRIMARY KEY,
    shop_name VARCHAR(255),
    merchant_id INT,
    FOREIGN KEY (merchant_id) REFERENCES Merchant(account_id)--check have_shop，不能超过3个
);
CREATE TABLE Account ( --超类
    account_id INT PRIMARY KEY,
    username VARCHAR(100),
    password_hash VARCHAR(255),
    email VARCHAR(255),
    have_shop BOOLEAN,
    created_at DATETIME
);
--本来想分开成customer和merchant的，感觉好像不用另存两个表
CREATE TABLE shipping_address (
    address VARCHAR(255),
    phone_number VARCHAR(50),
    name VARCHAR(100),
    customer_id INT,
    FOREIGN KEY (customer_id) REFERENCES Customer(account_id)
);
CREATE TABLE Cart ( --购物车可能有别的属性，暂时先留着
    cart_id INT PRIMARY KEY,
    customer_id INT UNIQUE,
    updated_at DATETIME
    FOREIGN KEY (customer_id) REFERENCES Customer(account_id)
);
CREATE TABLE CartItem (
    cart_item_id INT PRIMARY KEY,
    cart_id INT,
    sku_id INT,
    number INT,
    FOREIGN KEY (cart_id) REFERENCES Cart(cart_id),
    FOREIGN KEY (sku_id) REFERENCES SKU(sku_id)
);
CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    customer_id INT,
    status ENUM('PENDING','PAID','SHIPPED','FINISHED','CANCELLED'),
    FOREIGN KEY (customer_id) REFERENCES Customer(account_id)
);
CREATE TABLE Order_item (
    order_item_id INT PRIMARY KEY,
    order_id INT,
    number INT,
    sku_id INT,

    price_snapshot DECIMAL(10,2),
    shipping_address_snapshot VARCHAR(255),
    spu_name_snapshot VARCHAR(255),

    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (sku_id) REFERENCES SKU(sku_id)
);
CREATE TABLE SKUAttributeValue (
    sku_id INT,
    value_id INT,
    PRIMARY KEY (sku_id, value_id),
    FOREIGN KEY (sku_id) REFERENCES SKU(sku_id),
    FOREIGN KEY (value_id) REFERENCES AttributeValue(value_id)
);

```


###### 查找表的技巧

```sql
json_agg(json_build_object(
    'sku_id', k.sku_id,
    'now_price', k.now_price,
    'origin_price', k.origin_price
)) as skus
```
